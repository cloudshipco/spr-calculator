<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Small Producer Relief Calculator — Alcohol Duty</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --blue: #1d70b8;
      --dark-blue: #003078;
      --green: #00703c;
      --red: #d4351c;
      --black: #0b0c0c;
      --dark-grey: #505a5f;
      --mid-grey: #b1b4b6;
      --light-grey: #f3f2f1;
      --white: #ffffff;
      --yellow: #ffdd00;
      --focus: #fd0;
      --radius: 4px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--light-grey);
      color: var(--black);
      line-height: 1.5;
      min-height: 100vh;
    }

    header {
      background: var(--dark-blue);
      color: var(--white);
      padding: 1.5rem 1rem;
    }

    header .container {
      max-width: 720px;
      margin: 0 auto;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    header p {
      font-size: 1rem;
      opacity: 0.85;
    }

    main {
      max-width: 720px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
    }

    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--blue);
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
      font-size: 0.95rem;
    }

    .hint {
      display: block;
      color: var(--dark-grey);
      font-size: 0.85rem;
      margin-bottom: 0.35rem;
      font-weight: 400;
    }

    select, input[type="number"] {
      display: block;
      width: 100%;
      max-width: 320px;
      padding: 0.5rem 0.6rem;
      font-size: 1rem;
      border: 2px solid var(--black);
      border-radius: var(--radius);
      background: var(--white);
      font-family: inherit;
    }

    select:focus, input[type="number"]:focus {
      outline: 3px solid var(--focus);
      outline-offset: 0;
      border-color: var(--black);
    }

    .radio-group {
      display: flex;
      gap: 0.25rem;
    }

    .radio-group input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .radio-group label {
      display: inline-block;
      padding: 0.5rem 1.25rem;
      border: 2px solid var(--black);
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.95rem;
      transition: background 0.15s, color 0.15s;
      user-select: none;
    }

    .radio-group input[type="radio"]:checked + label {
      background: var(--dark-blue);
      color: var(--white);
      border-color: var(--dark-blue);
    }

    .radio-group input[type="radio"]:focus + label {
      outline: 3px solid var(--focus);
      outline-offset: 0;
    }

    .radio-group label:hover {
      background: var(--light-grey);
    }

    .radio-group input[type="radio"]:checked + label:hover {
      background: var(--blue);
    }

    .converter-toggle {
      display: inline-block;
      margin-top: 0.5rem;
      color: var(--blue);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      border: none;
      background: none;
      padding: 0;
      text-decoration: underline;
      font-family: inherit;
    }

    .converter-toggle:hover {
      color: var(--dark-blue);
    }

    .converter {
      display: none;
      margin-top: 0.75rem;
      padding: 1rem;
      background: var(--light-grey);
      border-radius: var(--radius);
      border-left: 4px solid var(--blue);
    }

    .converter.open {
      display: block;
    }

    .converter h3 {
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
    }

    .converter .form-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .converter .form-row .form-group {
      flex: 1;
      min-width: 140px;
    }

    .converter input[type="number"] {
      max-width: 100%;
    }

    .converter-result {
      margin-top: 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--dark-blue);
    }

    button.calculate {
      display: inline-block;
      padding: 0.75rem 2rem;
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--white);
      background: var(--green);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 2px 0 #004e2a;
      transition: background 0.15s;
    }

    button.calculate:hover {
      background: #005a30;
    }

    button.calculate:focus {
      outline: 3px solid var(--focus);
      outline-offset: 0;
    }

    button.calculate:active {
      box-shadow: none;
      transform: translateY(2px);
    }

    /* Results */
    #results {
      display: none;
    }

    #results.visible {
      display: block;
    }

    .result-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .result-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.25rem;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border-top: 4px solid var(--mid-grey);
    }

    .result-card.rate { border-top-color: var(--dark-grey); }
    .result-card.discount { border-top-color: var(--blue); }
    .result-card.spr { border-top-color: var(--green); }

    .result-card .result-label {
      font-size: 0.85rem;
      color: var(--dark-grey);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.35rem;
    }

    .result-card .result-value {
      font-size: 1.75rem;
      font-weight: 700;
    }

    .result-card.rate .result-value { color: var(--black); }
    .result-card.discount .result-value { color: var(--blue); }
    .result-card.spr .result-value { color: var(--green); }

    .result-card .result-unit {
      font-size: 0.75rem;
      color: var(--dark-grey);
      margin-top: 0.15rem;
    }

    .breakdown {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .breakdown h3 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--light-grey);
    }

    .breakdown-step {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.85rem;
      align-items: flex-start;
    }

    .breakdown-step:last-child {
      margin-bottom: 0;
    }

    .step-number {
      flex-shrink: 0;
      width: 1.75rem;
      height: 1.75rem;
      background: var(--blue);
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      margin-top: 0.1rem;
    }

    .step-content {
      flex: 1;
    }

    .step-content .step-label {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .step-content .step-detail {
      color: var(--dark-grey);
      font-size: 0.9rem;
    }

    .step-content .step-calc {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.85rem;
      background: var(--light-grey);
      padding: 0.35rem 0.6rem;
      border-radius: var(--radius);
      margin-top: 0.25rem;
      display: inline-block;
    }

    .message-box {
      padding: 1rem 1.25rem;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }

    .message-box.info {
      background: #e8f0fe;
      border-left: 4px solid var(--blue);
    }

    .message-box.warning {
      background: #fef3cd;
      border-left: 4px solid #f0ad4e;
    }

    .message-box strong {
      display: block;
      margin-bottom: 0.25rem;
    }

    footer {
      max-width: 720px;
      margin: 0 auto;
      padding: 0 1rem 2rem;
      font-size: 0.8rem;
      color: var(--dark-grey);
    }

    footer a {
      color: var(--blue);
    }

    /* Batch calculator */
    .batch-calc {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--light-grey);
    }

    .batch-calc h4 {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .batch-calc .form-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .batch-calc .form-row .form-group {
      flex: 1;
      min-width: 140px;
    }

    .batch-calc input[type="number"] {
      max-width: 100%;
    }

    .batch-result {
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--light-grey);
      border-radius: var(--radius);
      font-size: 0.9rem;
    }

    .batch-result .duty-amount {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--green);
    }

    @media (max-width: 480px) {
      header h1 { font-size: 1.35rem; }
      .result-cards { grid-template-columns: 1fr; }
      .result-card .result-value { font-size: 1.5rem; }
      .converter .form-row { flex-direction: column; gap: 0; }
      .batch-calc .form-row { flex-direction: column; gap: 0; }
    }
  </style>
</head>
<body>

<header>
  <div class="container">
    <h1>Small Producer Relief Calculator</h1>
    <p>Work out your Alcohol Duty rate with Small Producer Relief (SPR)</p>
  </div>
</header>

<main>

  <div class="card">
    <h2>Product details</h2>

    <div class="form-group">
      <label for="productType">Product type</label>
      <select id="productType">
        <option value="beer">Beer</option>
        <option value="cider_still">Cider (still)</option>
        <option value="cider_sparkling">Cider (sparkling)</option>
        <option value="wine">Wine and made-wine</option>
        <option value="spirits">Spirits</option>
        <option value="other_fermented">Other fermented products</option>
      </select>
    </div>

    <div class="form-group">
      <label>Serving type</label>
      <span class="hint">Draught means sold in containers of at least 20 litres and below 8.5% ABV</span>
      <div class="radio-group">
        <input type="radio" id="nonDraught" name="servingType" value="non_draught" checked>
        <label for="nonDraught">Non-draught</label>
        <input type="radio" id="draught" name="servingType" value="draught">
        <label for="draught">Draught</label>
      </div>
    </div>

    <div class="form-group">
      <label for="abv">ABV (%)</label>
      <span class="hint">The alcohol by volume strength of this product</span>
      <input type="number" id="abv" min="0.1" max="100" step="0.1" placeholder="e.g. 3.4">
    </div>
  </div>

  <div class="card">
    <h2>Annual production</h2>

    <div class="form-group">
      <label for="production">Total annual production</label>
      <span class="hint">Your total production across all alcoholic products, in hectolitres of pure alcohol. Must not exceed 4,500 hl.</span>
      <input type="number" id="production" min="0.01" max="4500" step="0.01" placeholder="e.g. 105">

      <button type="button" class="converter-toggle" id="converterToggle">Help me calculate this from product volume</button>

      <div class="converter" id="converter">
        <h3>Convert product volume to pure alcohol</h3>
        <p class="hint" style="margin-bottom: 0.75rem;">Enter your total annual product volume and its average ABV to calculate hectolitres of pure alcohol.</p>
        <div class="form-row">
          <div class="form-group">
            <label for="convVolume">Product volume (hectolitres)</label>
            <input type="number" id="convVolume" min="0" step="0.1" placeholder="e.g. 3000">
          </div>
          <div class="form-group">
            <label for="convAbv">Average ABV (%)</label>
            <input type="number" id="convAbv" min="0.1" max="100" step="0.1" placeholder="e.g. 3.5">
          </div>
        </div>
        <div class="converter-result" id="converterResult"></div>
      </div>
    </div>
  </div>

  <div style="text-align: center; margin-bottom: 1.5rem;">
    <button type="button" class="calculate" id="calculateBtn">Calculate SPR rate</button>
  </div>

  <div id="results">
    <div id="resultsContent"></div>
  </div>

</main>

<footer>
  <p>Rates effective from 1 February 2026. Based on <a href="https://www.gov.uk/guidance/how-to-work-out-your-alcohol-duty-rates-if-youre-eligible-for-small-producer-relief" target="_blank" rel="noopener">GOV.UK guidance on Small Producer Relief</a> and <a href="https://www.gov.uk/guidance/alcohol-duty-rates" target="_blank" rel="noopener">Alcohol Duty rates</a>. This calculator is for guidance only &mdash; always verify with HMRC.</p>
</footer>

<script>
/**
 * SPR Discount Band Tables
 * Each table is an array of bands: { start, end, marginal, cumulative }
 * Production must be > start and <= end for a band to apply.
 * Rates effective from 1 February 2026.
 */
const SPR_TABLES = {
  // Below 3.5% ABV — all products except spirits
  non_draught_products_below_3_5: [
    { start: 0,    end: 5,    marginal: 9.96,  cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.53,  cumulative: 49.80 },
    { start: 50,   end: 100,  marginal: 1.52,  cumulative: 163.74 },
    { start: 100,  end: 200,  marginal: 0.51,  cumulative: 239.71 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 290.35 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 290.35 },
    { start: 1000, end: 4500, marginal: -0.08, cumulative: 290.35 },
  ],
  draught_products_below_3_5: [
    { start: 0,    end: 5,    marginal: 8.58,  cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.18,  cumulative: 42.90 },
    { start: 50,   end: 100,  marginal: 1.31,  cumulative: 141.06 },
    { start: 100,  end: 200,  marginal: 0.44,  cumulative: 206.50 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 250.12 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 250.12 },
    { start: 1000, end: 4500, marginal: -0.07, cumulative: 250.12 },
  ],

  // Below 3.5% ABV — spirits only
  non_draught_spirits_below_3_5: [
    { start: 0,    end: 5,    marginal: 6.58,  cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.53,  cumulative: 32.92 },
    { start: 50,   end: 100,  marginal: 1.52,  cumulative: 146.86 },
    { start: 100,  end: 200,  marginal: 0.51,  cumulative: 222.82 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 273.47 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 273.47 },
    { start: 1000, end: 4500, marginal: -0.08, cumulative: 273.47 },
  ],
  draught_spirits_below_3_5: [
    { start: 0,    end: 5,    marginal: 5.67,  cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.18,  cumulative: 28.36 },
    { start: 50,   end: 100,  marginal: 1.31,  cumulative: 126.51 },
    { start: 100,  end: 200,  marginal: 0.44,  cumulative: 191.95 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 235.58 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 235.58 },
    { start: 1000, end: 4500, marginal: -0.07, cumulative: 235.58 },
  ],

  // 3.5% to below 8.5% ABV — Beer
  non_draught_beer: [
    { start: 0,    end: 5,     marginal: 20.67, cumulative: 0.00 },
    { start: 5,    end: 112.5, marginal: 11.48, cumulative: 103.34 },
    { start: 112.5,end: 225,   marginal: 10.33, cumulative: 1337.72 },
    { start: 225,  end: 450,   marginal: 5.74,  cumulative: 2500.33 },
    { start: 450,  end: 900,   marginal: 3.44,  cumulative: 3792.12 },
    { start: 900,  end: 1350,  marginal: 0.00,  cumulative: 5342.27 },
    { start: 1350, end: 4500,  marginal: -1.70, cumulative: 5342.27 },
  ],
  draught_beer: [
    { start: 0,    end: 5,     marginal: 17.80, cumulative: 0.00 },
    { start: 5,    end: 112.5, marginal: 9.89,  cumulative: 89.02 },
    { start: 112.5,end: 225,   marginal: 8.90,  cumulative: 1152.29 },
    { start: 225,  end: 450,   marginal: 4.95,  cumulative: 2153.74 },
    { start: 450,  end: 900,   marginal: 2.97,  cumulative: 3266.46 },
    { start: 900,  end: 1350,  marginal: 0.00,  cumulative: 4601.73 },
    { start: 1350, end: 4500,  marginal: -1.46, cumulative: 4601.73 },
  ],

  // 3.5% to below 8.5% ABV — Cider (still, and sparkling up to 5.5%)
  non_draught_cider: [
    { start: 0,    end: 5,    marginal: 10.39, cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.64,  cumulative: 51.95 },
    { start: 50,   end: 100,  marginal: 1.59,  cumulative: 170.87 },
    { start: 100,  end: 200,  marginal: 0.53,  cumulative: 250.15 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 303.00 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 303.00 },
    { start: 1000, end: 4500, marginal: -0.09, cumulative: 303.00 },
  ],
  draught_cider: [
    { start: 0,    end: 5,    marginal: 8.95,  cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.28,  cumulative: 44.75 },
    { start: 50,   end: 100,  marginal: 1.37,  cumulative: 147.19 },
    { start: 100,  end: 200,  marginal: 0.46,  cumulative: 215.48 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 261.01 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 261.01 },
    { start: 1000, end: 4500, marginal: -0.07, cumulative: 261.01 },
  ],

  // 3.5% to below 8.5% ABV — Wine, fermented products, sparkling cider over 5.5%
  non_draught_wine: [
    { start: 0,    end: 5,    marginal: 26.61, cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.71,  cumulative: 133.05 },
    { start: 50,   end: 100,  marginal: 2.71,  cumulative: 254.84 },
    { start: 100,  end: 200,  marginal: 1.35,  cumulative: 390.16 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 525.48 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 525.48 },
    { start: 1000, end: 4500, marginal: -0.15, cumulative: 525.48 },
  ],
  draught_wine: [
    { start: 0,    end: 5,    marginal: 19.45, cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 1.98,  cumulative: 97.25 },
    { start: 50,   end: 100,  marginal: 1.98,  cumulative: 186.27 },
    { start: 100,  end: 200,  marginal: 0.99,  cumulative: 285.18 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 384.09 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 384.09 },
    { start: 1000, end: 4500, marginal: -0.11, cumulative: 384.09 },
  ],

  // 3.5% to below 8.5% ABV — Spirits
  non_draught_spirits: [
    { start: 0,    end: 5,    marginal: 21.65, cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 2.71,  cumulative: 108.26 },
    { start: 50,   end: 100,  marginal: 2.71,  cumulative: 230.04 },
    { start: 100,  end: 200,  marginal: 1.35,  cumulative: 365.36 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 500.68 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 500.68 },
    { start: 1000, end: 4500, marginal: -0.14, cumulative: 500.68 },
  ],
  draught_spirits: [
    { start: 0,    end: 5,    marginal: 15.83, cumulative: 0.00 },
    { start: 5,    end: 50,   marginal: 1.98,  cumulative: 79.13 },
    { start: 50,   end: 100,  marginal: 1.98,  cumulative: 168.15 },
    { start: 100,  end: 200,  marginal: 0.99,  cumulative: 267.05 },
    { start: 200,  end: 600,  marginal: 0.00,  cumulative: 365.96 },
    { start: 600,  end: 1000, marginal: 0.00,  cumulative: 365.96 },
    { start: 1000, end: 4500, marginal: -0.10, cumulative: 365.96 },
  ],
};

/**
 * Standard duty rates per litre of pure alcohol.
 * Returns { rate, description } or null if duty-free.
 */
function getStandardRate(productType, isDraught, abv) {
  if (abv <= 1.2) {
    return { rate: 0, description: "Duty-free (1.2% ABV or below)" };
  }

  /* Draught rates only apply below 8.5% ABV */
  if (isDraught && abv >= 8.5) {
    return null; // invalid — draught only below 8.5%
  }

  if (abv < 3.5) {
    /* 1.3% to below 3.5% — same rate for all products */
    return {
      rate: isDraught ? 8.58 : 9.96,
      description: `${isDraught ? "Draught" : "Non-draught"} products, 1.3% to 3.4% ABV`,
    };
  }

  if (abv < 8.5) {
    /* 3.5% to below 8.5% — rates vary by product */
    if (productType === "beer") {
      return {
        rate: isDraught ? 19.45 : 22.58,
        description: `${isDraught ? "Draught" : "Non-draught"} beer, 3.5% to 8.4% ABV`,
      };
    }
    if (productType === "cider_still") {
      return {
        rate: isDraught ? 8.95 : 10.39,
        description: `${isDraught ? "Draught" : "Non-draught"} cider (still), 3.5% to 8.4% ABV`,
      };
    }
    if (productType === "cider_sparkling") {
      if (abv <= 5.5) {
        return {
          rate: isDraught ? 8.95 : 10.39,
          description: `${isDraught ? "Draught" : "Non-draught"} cider (sparkling), 3.5% to 5.5% ABV`,
        };
      } else {
        return {
          rate: isDraught ? 19.45 : 26.61,
          description: `${isDraught ? "Draught" : "Non-draught"} cider (sparkling), over 5.5% to 8.4% ABV`,
        };
      }
    }
    /* Wine, spirits, other fermented — same standard rate */
    const typeLabel = {
      wine: "wine and made-wine",
      spirits: "spirits",
      other_fermented: "other fermented products",
    }[productType];
    return {
      rate: isDraught ? 19.45 : 26.61,
      description: `${isDraught ? "Draught" : "Non-draught"} ${typeLabel}, 3.5% to 8.4% ABV`,
    };
  }

  /* 8.5% and above — no draught rate, no SPR */
  if (abv < 22) {
    return {
      rate: 30.62,
      description: "Non-draught products, 8.5% to 22% ABV",
    };
  }

  return {
    rate: 33.99,
    description: "Non-draught products, above 22% ABV",
  };
}

/**
 * Determine which SPR discount table to use.
 * Returns { tableKey, tableName } or null if SPR doesn't apply.
 */
function getSPRTable(productType, isDraught, abv) {
  if (abv <= 1.2 || abv >= 8.5) return null;

  const prefix = isDraught ? "draught" : "non_draught";

  if (abv < 3.5) {
    if (productType === "spirits") {
      return {
        tableKey: `${prefix}_spirits_below_3_5`,
        tableName: `${isDraught ? "Draught" : "Non-draught"} spirits below 3.5% ABV`,
      };
    }
    return {
      tableKey: `${prefix}_products_below_3_5`,
      tableName: `${isDraught ? "Draught" : "Non-draught"} alcoholic products below 3.5% ABV`,
    };
  }

  /* 3.5% to below 8.5% */
  if (productType === "beer") {
    return { tableKey: `${prefix}_beer`, tableName: `${isDraught ? "Draught" : "Non-draught"} beer (3.5% to 8.5% ABV)` };
  }
  if (productType === "cider_still" || (productType === "cider_sparkling" && abv <= 5.5)) {
    return { tableKey: `${prefix}_cider`, tableName: `${isDraught ? "Draught" : "Non-draught"} cider (3.5% to 8.5% ABV)` };
  }
  if (productType === "spirits") {
    return { tableKey: `${prefix}_spirits`, tableName: `${isDraught ? "Draught" : "Non-draught"} spirits (3.5% to 8.5% ABV)` };
  }
  /* Wine, other fermented, sparkling cider >5.5% */
  return { tableKey: `${prefix}_wine`, tableName: `${isDraught ? "Draught" : "Non-draught"} wine and fermented products (3.5% to 8.5% ABV)` };
}

/**
 * Calculate the SPR discount using a band table.
 * Returns { totalDiscount, perLitreDiscount, band, bandIndex }
 */
function calculateDiscount(bands, productionHL) {
  let band = null;
  let bandIndex = -1;

  for (let i = 0; i < bands.length; i++) {
    if (productionHL > bands[i].start && productionHL <= bands[i].end) {
      band = bands[i];
      bandIndex = i;
      break;
    }
  }

  if (!band) return null;

  const totalDiscount = (productionHL - band.start) * band.marginal + band.cumulative;
  const perLitreDiscount = totalDiscount / productionHL;

  return {
    totalDiscount: Math.max(0, totalDiscount),
    perLitreDiscount: Math.max(0, perLitreDiscount),
    band,
    bandIndex: bandIndex + 1, // 1-based for display
  };
}

/**
 * Format a number as currency (£X.XX)
 */
function formatCurrency(value) {
  if (value < 0) return "-£" + Math.abs(value).toFixed(2);
  return "£" + value.toFixed(2);
}

/**
 * Format a number with commas
 */
function formatNumber(value) {
  return value.toLocaleString("en-GB", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/**
 * Main calculation and rendering
 */
function calculate() {
  const productType = document.getElementById("productType").value;
  const isDraught = document.querySelector('input[name="servingType"]:checked').value === "draught";
  const abvInput = document.getElementById("abv").value;
  const productionInput = document.getElementById("production").value;

  const resultsEl = document.getElementById("results");
  const contentEl = document.getElementById("resultsContent");

  /* Validation */
  if (!abvInput || !productionInput) {
    contentEl.innerHTML = '<div class="message-box warning"><strong>Missing information</strong>Please enter both the ABV and your annual production volume.</div>';
    resultsEl.classList.add("visible");
    return;
  }

  const abv = parseFloat(abvInput);
  const productionHL = parseFloat(productionInput);

  if (isNaN(abv) || abv <= 0 || abv > 100) {
    contentEl.innerHTML = '<div class="message-box warning"><strong>Invalid ABV</strong>Please enter a valid ABV between 0.1% and 100%.</div>';
    resultsEl.classList.add("visible");
    return;
  }

  if (isNaN(productionHL) || productionHL <= 0) {
    contentEl.innerHTML = '<div class="message-box warning"><strong>Invalid production volume</strong>Please enter a production volume greater than 0.</div>';
    resultsEl.classList.add("visible");
    return;
  }

  if (productionHL > 4500) {
    contentEl.innerHTML = '<div class="message-box warning"><strong>Not eligible for SPR</strong>Small Producer Relief is only available for producers with annual production of 4,500 hectolitres of pure alcohol or less.</div>';
    resultsEl.classList.add("visible");
    return;
  }

  /* Draught + high ABV check */
  if (isDraught && abv >= 8.5) {
    contentEl.innerHTML = '<div class="message-box warning"><strong>Draught relief not available</strong>Draught relief only applies to products below 8.5% ABV. Please select non-draught or reduce the ABV.</div>';
    resultsEl.classList.add("visible");
    return;
  }

  /* Get standard rate */
  const rateInfo = getStandardRate(productType, isDraught, abv);

  if (!rateInfo) {
    contentEl.innerHTML = '<div class="message-box warning"><strong>Unable to calculate</strong>Could not determine the duty rate for this product.</div>';
    resultsEl.classList.add("visible");
    return;
  }

  /* Duty-free products */
  if (rateInfo.rate === 0) {
    contentEl.innerHTML = `
      <div class="message-box info">
        <strong>No duty payable</strong>
        Products at 1.2% ABV or below are duty-free. No Small Producer Relief calculation is needed.
      </div>`;
    resultsEl.classList.add("visible");
    return;
  }

  /* Get SPR table */
  const sprInfo = getSPRTable(productType, isDraught, abv);

  if (!sprInfo) {
    contentEl.innerHTML = `
      <div class="result-cards">
        <div class="result-card rate">
          <div class="result-label">Full Duty Rate</div>
          <div class="result-value">${formatCurrency(rateInfo.rate)}</div>
          <div class="result-unit">per litre of pure alcohol</div>
        </div>
      </div>
      <div class="message-box info">
        <strong>SPR not available for this product</strong>
        Small Producer Relief discount tables are only provided for products below 8.5% ABV. The full duty rate of ${formatCurrency(rateInfo.rate)} per litre of pure alcohol applies.
      </div>`;
    resultsEl.classList.add("visible");
    return;
  }

  /* Calculate discount */
  const bands = SPR_TABLES[sprInfo.tableKey];
  const discountResult = calculateDiscount(bands, productionHL);

  if (!discountResult) {
    contentEl.innerHTML = '<div class="message-box warning"><strong>Calculation error</strong>Could not find a matching band for your production volume.</div>';
    resultsEl.classList.add("visible");
    return;
  }

  const perLitreDiscountRounded = Math.ceil(discountResult.perLitreDiscount * 100) / 100;
  const sprRate = Math.round((rateInfo.rate - perLitreDiscountRounded) * 100) / 100;
  const savingPercent = ((perLitreDiscountRounded / rateInfo.rate) * 100).toFixed(0);

  const productLabels = {
    beer: "beer",
    cider_still: "still cider",
    cider_sparkling: "sparkling cider",
    wine: "wine",
    spirits: "spirits",
    other_fermented: "other fermented products",
  };

  const productLabel = productLabels[productType];
  const servingLabel = isDraught ? "draught" : "non-draught";

  let html = `
    <div class="result-cards">
      <div class="result-card rate">
        <div class="result-label">Full Duty Rate</div>
        <div class="result-value">${formatCurrency(rateInfo.rate)}</div>
        <div class="result-unit">per litre of pure alcohol</div>
      </div>
      <div class="result-card discount">
        <div class="result-label">Your Discount</div>
        <div class="result-value">${formatCurrency(perLitreDiscountRounded)}</div>
        <div class="result-unit">per litre of pure alcohol (${savingPercent}%)</div>
      </div>
      <div class="result-card spr">
        <div class="result-label">Your SPR Rate</div>
        <div class="result-value">${formatCurrency(sprRate)}</div>
        <div class="result-unit">per litre of pure alcohol</div>
      </div>
    </div>

    <div class="breakdown">
      <h3>Calculation breakdown</h3>

      <div class="breakdown-step">
        <div class="step-number">1</div>
        <div class="step-content">
          <div class="step-label">Product: ${servingLabel} ${productLabel} at ${abv}% ABV</div>
          <div class="step-detail">Full Alcohol Duty rate: ${formatCurrency(rateInfo.rate)} per litre of pure alcohol</div>
          <div class="step-detail" style="color: var(--dark-grey); font-size: 0.8rem;">${rateInfo.description}</div>
        </div>
      </div>

      <div class="breakdown-step">
        <div class="step-number">2</div>
        <div class="step-content">
          <div class="step-label">Discount table: ${sprInfo.tableName}</div>
          <div class="step-detail">Your production of ${formatNumber(productionHL)} hl falls in Band ${discountResult.bandIndex} (${formatNumber(discountResult.band.start)} to ${formatNumber(discountResult.band.end)} hl)</div>
        </div>
      </div>

      <div class="breakdown-step">
        <div class="step-number">3</div>
        <div class="step-content">
          <div class="step-label">Calculate total discount</div>
          <div class="step-detail">(Production &minus; Band start) &times; Marginal + Cumulative</div>
          <div class="step-calc">(${formatNumber(productionHL)} &minus; ${formatNumber(discountResult.band.start)}) &times; ${formatCurrency(discountResult.band.marginal)} + ${formatCurrency(discountResult.band.cumulative)} = ${formatCurrency(discountResult.totalDiscount)}</div>
        </div>
      </div>

      <div class="breakdown-step">
        <div class="step-number">4</div>
        <div class="step-content">
          <div class="step-label">Discount per litre of pure alcohol</div>
          <div class="step-detail">Total discount &divide; production</div>
          <div class="step-calc">${formatCurrency(discountResult.totalDiscount)} &divide; ${formatNumber(productionHL)} = ${formatCurrency(perLitreDiscountRounded)}</div>
        </div>
      </div>

      <div class="breakdown-step">
        <div class="step-number">5</div>
        <div class="step-content">
          <div class="step-label">Your Small Producer Rate</div>
          <div class="step-detail">Full rate &minus; discount</div>
          <div class="step-calc">${formatCurrency(rateInfo.rate)} &minus; ${formatCurrency(perLitreDiscountRounded)} = <strong>${formatCurrency(sprRate)}</strong></div>
        </div>
      </div>

      <div class="batch-calc">
        <h4>How much duty on a batch?</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="batchVolume">Batch volume (litres of product)</label>
            <input type="number" id="batchVolume" min="0" step="1" placeholder="e.g. 500">
          </div>
        </div>
        <div id="batchResult" class="batch-result" style="display: none;"></div>
      </div>
    </div>`;

  contentEl.innerHTML = html;
  resultsEl.classList.add("visible");

  /* Scroll to results */
  resultsEl.scrollIntoView({ behavior: "smooth", block: "start" });

  /* Batch calculator */
  const batchInput = document.getElementById("batchVolume");
  const batchResultEl = document.getElementById("batchResult");

  function updateBatch() {
    const batchLitres = parseFloat(batchInput.value);
    if (!batchLitres || batchLitres <= 0) {
      batchResultEl.style.display = "none";
      return;
    }
    const pureAlcoholLitres = batchLitres * (abv / 100);
    const dutyAtFullRate = pureAlcoholLitres * rateInfo.rate;
    const dutyAtSPR = pureAlcoholLitres * sprRate;
    const saving = dutyAtFullRate - dutyAtSPR;

    batchResultEl.innerHTML = `
      For <strong>${batchLitres.toLocaleString("en-GB")} litres</strong> of product at <strong>${abv}% ABV</strong>
      (${pureAlcoholLitres.toFixed(2)} litres of pure alcohol):<br>
      Duty at full rate: ${formatCurrency(dutyAtFullRate)}<br>
      <strong>Duty at your SPR rate: <span class="duty-amount">${formatCurrency(dutyAtSPR)}</span></strong><br>
      You save: ${formatCurrency(saving)}
    `;
    batchResultEl.style.display = "block";
  }

  batchInput.addEventListener("input", updateBatch);
}

/* Event listeners */
document.getElementById("calculateBtn").addEventListener("click", calculate);

/* Allow Enter key to trigger calculation */
document.querySelectorAll("input[type='number']").forEach(input => {
  input.addEventListener("keydown", (event) => {
    if (event.key === "Enter") calculate();
  });
});

/* Volume converter toggle */
document.getElementById("converterToggle").addEventListener("click", () => {
  const converter = document.getElementById("converter");
  converter.classList.toggle("open");
  const toggle = document.getElementById("converterToggle");
  toggle.textContent = converter.classList.contains("open")
    ? "Hide converter"
    : "Help me calculate this from product volume";
});

/* Volume converter calculation */
function updateConverter() {
  const volume = parseFloat(document.getElementById("convVolume").value);
  const abv = parseFloat(document.getElementById("convAbv").value);
  const resultEl = document.getElementById("converterResult");

  if (!volume || !abv || volume <= 0 || abv <= 0) {
    resultEl.textContent = "";
    return;
  }

  const pureAlcohol = volume * (abv / 100);
  resultEl.innerHTML = `= <strong>${formatNumber(pureAlcohol)} hectolitres</strong> of pure alcohol
    <button type="button" style="margin-left: 0.5rem; font-size: 0.8rem; padding: 0.2rem 0.6rem; cursor: pointer; border: 1px solid var(--blue); background: var(--white); color: var(--blue); border-radius: var(--radius); font-family: inherit;" onclick="document.getElementById('production').value = ${pureAlcohol.toFixed(2)}; this.textContent = 'Done';">Use this value</button>`;
}

document.getElementById("convVolume").addEventListener("input", updateConverter);
document.getElementById("convAbv").addEventListener("input", updateConverter);
</script>

</body>
</html>
